<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="css/leaflet.css">
        
        <!-- Other CSS -->
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        
         
        <!-- Leaflet Elevation CSS -->
        <link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.css" />
        
        <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        #container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }        
        #map {
            width: 100%;
            flex: 1;
        }
        #elevation-div {
            width: 100%;
            height: 25%;
            font: 12px/1.5 "Helvetica Neue", Arial, Helvetica, sans-serif;
            background: white;
            border-top: 1px solid #ccc;
        }
        </style>
        
       <!-- D3.js v7 (complete library) -->
       <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
       
       <!-- Leaflet JS -->
       <script src="js/leaflet.js"></script>
       
       <!-- Leaflet Plugins -->
<!-- Leaflet Elevation plugin -->
         <link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation@2.5.1/dist/leaflet-elevation.min.css" />
         <script src="https://unpkg.com/d3@7.8.4/dist/d3.min.js"></script>
         <script src="https://unpkg.com/@raruto/leaflet-elevation@2.5.1/dist/leaflet-elevation.min.js"></script>
        

         <!-- Optional: Distance markers -->
        <link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation@2.5.1/libs/leaflet-distance-marker.css" />
        <script src="https://unpkg.com/@raruto/leaflet-elevation@2.5.1/libs/leaflet-distance-marker.js"></script>


         <script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.7.0/gpx.min.js"></script>
        
        </style>
        <title>Sassquad South Mountain Reservation Races</title>
    </head>
    <body>
        <div id="container">
            <div id="map"></div>
            <div id="elevation-div" style="position: relative;">
                <button id="close-elevation" style="
                    position: absolute;
                    top: 5px;
                    right: 10px;
                    z-index: 1000;
                    padding: 4px 8px;
                    background-color: #fff;
                    border: 1px solid #ccc;
                    cursor: pointer;
                    font-size: 12px;
                ">✖ Close</button>
            </div>
        </div>
        
        <!-- Other Scripts -->
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-measure.js"></script>
        
        <!-- Data Layers -->
        <script src="data/Contours20ftIntervals_1.js"></script>
        <script src="data/FrostyandSquatchyLeftoversLoop_2.js"></script>
        <script src="data/BlueLoop_3.js"></script>
        <script src="data/CheckeredLoop_4.js"></script>
        <script src="data/YellowBlackLoop_5.js"></script>
        <script src="data/PinkLoop_6.js"></script>
        <script src="data/PinkTurtlebackLoop_7.js"></script>
        <script src="data/GreenLocustGroveLoop_8.js"></script>
        <script src="data/BlueMayappleLoop_9.js"></script>
        <script src="data/SquatchHQ_10.js"></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:22, minZoom:13
        }).fitBounds([[40.701725830404236,-74.32841164050683],[40.78694637519182,-74.25959517263713]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // add class to format popup if it contains media
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					// Delay to force the redraw
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var title = new L.Control({'position':'topleft'});
        title.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        title.update = function () {
            this._div.innerHTML = '<h2>Sassquad South Mountain Reservation Races</h2>';
        };
        title.addTo(map);
        var abstract = new L.Control({'position':'topright'});
        abstract.onAdd = function (map) {
            this._div = L.DomUtil.create('div',
            'leaflet-control abstract');
            this._div.id = 'abstract'
                this._div.setAttribute("onmouseenter", "abstract.show()");
                this._div.setAttribute("onmouseleave", "abstract.hide()");
                this.hide();
                return this._div;
            };
            abstract.hide = function () {
                this._div.classList.remove("abstractUncollapsed");
                this._div.classList.add("abstract");
                this._div.innerHTML = 'i'
            }
            abstract.show = function () {
                this._div.classList.remove("abstract");
                this._div.classList.add("abstractUncollapsed");
                this._div.innerHTML = 'Here is a web map containing routes and information for Sassquad events that occur on South Mountain Reservation, in Essex County New Jersey. Use the layer list to toggle on and off routes which are used in the mountain for our races. Click a route to view more information about it!';
        };
        abstract.addTo(map);
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OSMStandard_0');
        map.getPane('pane_OSMStandard_0').style.zIndex = 400;
        var layer_OSMStandard_0 = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OSMStandard_0',
            opacity: 1.0,
            attribution: '<a href="https://www.openstreetmap.org/copyright">© OpenStreetMap contributors, CC-BY-SA</a>',
            minZoom: 13,
            maxZoom: 22,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OSMStandard_0;
        map.addLayer(layer_OSMStandard_0);
        function pop_Contours20ftIntervals_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ID'] !== null ? autolinker.link(String(feature.properties['ID']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ELEV'] !== null ? autolinker.link(String(feature.properties['ELEV']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Area'] !== null ? autolinker.link(String(feature.properties['Area']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Contours20ftIntervals_1_0() {
            return {
                pane: 'pane_Contours20ftIntervals_1',
                opacity: 1,
                color: 'rgba(183,180,178,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
        }
        map.createPane('pane_Contours20ftIntervals_1');
        map.getPane('pane_Contours20ftIntervals_1').style.zIndex = 401;
        map.getPane('pane_Contours20ftIntervals_1').style['mix-blend-mode'] = 'normal';
        var layer_Contours20ftIntervals_1 = new L.geoJson(json_Contours20ftIntervals_1, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Contours20ftIntervals_1',
            layerName: 'layer_Contours20ftIntervals_1',
            pane: 'pane_Contours20ftIntervals_1',
            onEachFeature: pop_Contours20ftIntervals_1,
            style: style_Contours20ftIntervals_1_0,
        });
        bounds_group.addLayer(layer_Contours20ftIntervals_1);
        map.addLayer(layer_Contours20ftIntervals_1);
        function pop_FrostyandSquatchyLeftoversLoop_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Description:</th>\
                        <td>' + (feature.properties['Description:'] !== null ? autolinker.link(String(feature.properties['Description:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_FrostyandSquatchyLeftoversLoop_2_0() {
            return {
                pane: 'pane_FrostyandSquatchyLeftoversLoop_2',
                opacity: 1,
                color: 'rgba(241,79,22,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_FrostyandSquatchyLeftoversLoop_2');
        map.getPane('pane_FrostyandSquatchyLeftoversLoop_2').style.zIndex = 402;
        map.getPane('pane_FrostyandSquatchyLeftoversLoop_2').style['mix-blend-mode'] = 'normal';
        var layer_FrostyandSquatchyLeftoversLoop_2 = new L.geoJson(json_FrostyandSquatchyLeftoversLoop_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_FrostyandSquatchyLeftoversLoop_2',
            layerName: 'layer_FrostyandSquatchyLeftoversLoop_2',
            pane: 'pane_FrostyandSquatchyLeftoversLoop_2',
            onEachFeature: pop_FrostyandSquatchyLeftoversLoop_2,
            style: style_FrostyandSquatchyLeftoversLoop_2_0,
        });
        bounds_group.addLayer(layer_FrostyandSquatchyLeftoversLoop_2);
        map.addLayer(layer_FrostyandSquatchyLeftoversLoop_2);
        function pop_BlueLoop_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_BlueLoop_3_0() {
            return {
                pane: 'pane_BlueLoop_3',
                opacity: 1,
                color: 'rgba(0,109,153,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_BlueLoop_3');
        map.getPane('pane_BlueLoop_3').style.zIndex = 403;
        map.getPane('pane_BlueLoop_3').style['mix-blend-mode'] = 'normal';
        var layer_BlueLoop_3 = new L.geoJson(json_BlueLoop_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_BlueLoop_3',
            layerName: 'layer_BlueLoop_3',
            pane: 'pane_BlueLoop_3',
            onEachFeature: pop_BlueLoop_3,
            style: style_BlueLoop_3_0,
        });
        bounds_group.addLayer(layer_BlueLoop_3);
        map.addLayer(layer_BlueLoop_3);
        function pop_CheckeredLoop_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_CheckeredLoop_4_0() {
            return {
                pane: 'pane_CheckeredLoop_4',
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '12.0,6.0',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_CheckeredLoop_4');
        map.getPane('pane_CheckeredLoop_4').style.zIndex = 404;
        map.getPane('pane_CheckeredLoop_4').style['mix-blend-mode'] = 'normal';
        var layer_CheckeredLoop_4 = new L.geoJson(json_CheckeredLoop_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_CheckeredLoop_4',
            layerName: 'layer_CheckeredLoop_4',
            pane: 'pane_CheckeredLoop_4',
            onEachFeature: pop_CheckeredLoop_4,
            style: style_CheckeredLoop_4_0,
        });
        bounds_group.addLayer(layer_CheckeredLoop_4);
        map.addLayer(layer_CheckeredLoop_4);
        function pop_YellowBlackLoop_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_YellowBlackLoop_5_0() {
            return {
                pane: 'pane_YellowBlackLoop_5',
                opacity: 1,
                color: 'rgba(224,231,72,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_YellowBlackLoop_5');
        map.getPane('pane_YellowBlackLoop_5').style.zIndex = 405;
        map.getPane('pane_YellowBlackLoop_5').style['mix-blend-mode'] = 'normal';
        var layer_YellowBlackLoop_5 = new L.geoJson(json_YellowBlackLoop_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_YellowBlackLoop_5',
            layerName: 'layer_YellowBlackLoop_5',
            pane: 'pane_YellowBlackLoop_5',
            onEachFeature: pop_YellowBlackLoop_5,
            style: style_YellowBlackLoop_5_0,
        });
        bounds_group.addLayer(layer_YellowBlackLoop_5);
        map.addLayer(layer_YellowBlackLoop_5);
        function pop_PinkLoop_6(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_PinkLoop_6_0() {
            return {
                pane: 'pane_PinkLoop_6',
                opacity: 1,
                color: 'rgba(231,11,158,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_PinkLoop_6');
        map.getPane('pane_PinkLoop_6').style.zIndex = 406;
        map.getPane('pane_PinkLoop_6').style['mix-blend-mode'] = 'normal';
        var layer_PinkLoop_6 = new L.geoJson(json_PinkLoop_6, {
            attribution: '',
            interactive: true,
            dataVar: 'json_PinkLoop_6',
            layerName: 'layer_PinkLoop_6',
            pane: 'pane_PinkLoop_6',
            onEachFeature: pop_PinkLoop_6,
            style: style_PinkLoop_6_0,
        });
        bounds_group.addLayer(layer_PinkLoop_6);
        map.addLayer(layer_PinkLoop_6);
        function pop_PinkTurtlebackLoop_7(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Terrain:</th>\
                        <td>' + (feature.properties['Terrain:'] !== null ? autolinker.link(String(feature.properties['Terrain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Description:</th>\
                        <td>' + (feature.properties['Description:'] !== null ? autolinker.link(String(feature.properties['Description:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_PinkTurtlebackLoop_7_0() {
            return {
                pane: 'pane_PinkTurtlebackLoop_7',
                opacity: 1,
                color: 'rgba(232,113,141,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_PinkTurtlebackLoop_7');
        map.getPane('pane_PinkTurtlebackLoop_7').style.zIndex = 407;
        map.getPane('pane_PinkTurtlebackLoop_7').style['mix-blend-mode'] = 'normal';
        var layer_PinkTurtlebackLoop_7 = new L.geoJson(json_PinkTurtlebackLoop_7, {
            attribution: '',
            interactive: true,
            dataVar: 'json_PinkTurtlebackLoop_7',
            layerName: 'layer_PinkTurtlebackLoop_7',
            pane: 'pane_PinkTurtlebackLoop_7',
            onEachFeature: pop_PinkTurtlebackLoop_7,
            style: style_PinkTurtlebackLoop_7_0,
        });
        bounds_group.addLayer(layer_PinkTurtlebackLoop_7);
        map.addLayer(layer_PinkTurtlebackLoop_7);
        function pop_GreenLocustGroveLoop_8(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Terrain:</th>\
                        <td>' + (feature.properties['Terrain:'] !== null ? autolinker.link(String(feature.properties['Terrain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Description:</th>\
                        <td>' + (feature.properties['Description:'] !== null ? autolinker.link(String(feature.properties['Description:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_GreenLocustGroveLoop_8_0() {
            return {
                pane: 'pane_GreenLocustGroveLoop_8',
                opacity: 1,
                color: 'rgba(84,176,74,1.0)',
                dashArray: '12.0,6.0',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_GreenLocustGroveLoop_8');
        map.getPane('pane_GreenLocustGroveLoop_8').style.zIndex = 408;
        map.getPane('pane_GreenLocustGroveLoop_8').style['mix-blend-mode'] = 'normal';
        var layer_GreenLocustGroveLoop_8 = new L.geoJson(json_GreenLocustGroveLoop_8, {
            attribution: '',
            interactive: true,
            dataVar: 'json_GreenLocustGroveLoop_8',
            layerName: 'layer_GreenLocustGroveLoop_8',
            pane: 'pane_GreenLocustGroveLoop_8',
            onEachFeature: pop_GreenLocustGroveLoop_8,
            style: style_GreenLocustGroveLoop_8_0,
        });
        bounds_group.addLayer(layer_GreenLocustGroveLoop_8);
        map.addLayer(layer_GreenLocustGroveLoop_8);
        function pop_BlueMayappleLoop_9(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name:</th>\
                        <td>' + (feature.properties['Name:'] !== null ? autolinker.link(String(feature.properties['Name:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Terrain:</th>\
                        <td>' + (feature.properties['Terrain:'] !== null ? autolinker.link(String(feature.properties['Terrain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Description:</th>\
                        <td>' + (feature.properties['Description:'] !== null ? autolinker.link(String(feature.properties['Description:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Elevation Gain:</th>\
                        <td>' + (feature.properties['Elevation Gain:'] !== null ? autolinker.link(String(feature.properties['Elevation Gain:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Length:</th>\
                        <td>' + (feature.properties['Length:'] !== null ? autolinker.link(String(feature.properties['Length:']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_BlueMayappleLoop_9_0() {
            return {
                pane: 'pane_BlueMayappleLoop_9',
                opacity: 1,
                color: 'rgba(41,53,213,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_BlueMayappleLoop_9');
        map.getPane('pane_BlueMayappleLoop_9').style.zIndex = 409;
        map.getPane('pane_BlueMayappleLoop_9').style['mix-blend-mode'] = 'normal';
        var layer_BlueMayappleLoop_9 = new L.geoJson(json_BlueMayappleLoop_9, {
            attribution: '',
            interactive: true,
            dataVar: 'json_BlueMayappleLoop_9',
            layerName: 'layer_BlueMayappleLoop_9',
            pane: 'pane_BlueMayappleLoop_9',
            onEachFeature: pop_BlueMayappleLoop_9,
            style: style_BlueMayappleLoop_9_0,
        });
        bounds_group.addLayer(layer_BlueMayappleLoop_9);
        map.addLayer(layer_BlueMayappleLoop_9);
        function pop_SquatchHQ_10(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
                click: function(e) {
            // Stop propagation to prevent map click from triggering
            if (e.originalEvent) {
                e.originalEvent.stopPropagation();
            }
            
            if (feature.properties && feature.properties.gpx_file) {
                const gpxFileName = feature.properties.gpx_file;
                const gpxFilePath = `gpx_files/${gpxFileName}`;
                console.log("Clicked feature with GPX:", gpxFilePath);
                loadGPXElevation(gpxFilePath);
            } else {
                console.log("Clicked feature has no GPX file associated");
            }
        }
    });
            
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name</th>\
                        <td>' + (feature.properties['Name'] !== null ? autolinker.link(String(feature.properties['Name']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_SquatchHQ_10_0() {
            return {
                pane: 'pane_SquatchHQ_10',
                shape: 'triangle',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(0,0,0,1.0)',
                interactive: false,
            }
        }
        map.createPane('pane_SquatchHQ_10');
        map.getPane('pane_SquatchHQ_10').style.zIndex = 410;
        map.getPane('pane_SquatchHQ_10').style['mix-blend-mode'] = 'normal';
        var layer_SquatchHQ_10 = new L.geoJson(json_SquatchHQ_10, {
            attribution: '',
            interactive: false,
            dataVar: 'json_SquatchHQ_10',
            layerName: 'layer_SquatchHQ_10',
            pane: 'pane_SquatchHQ_10',
            onEachFeature: pop_SquatchHQ_10,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.shapeMarker(latlng, style_SquatchHQ_10_0(feature));
            },
        });
        bounds_group.addLayer(layer_SquatchHQ_10);
        map.addLayer(layer_SquatchHQ_10);
        map.on("zoomend", function(e) {
            if (map.getZoom() <= 19 && map.getZoom() >= 15) {
                map.addLayer(layer_Contours20ftIntervals_1);
            } else if (map.getZoom() > 19 || map.getZoom() < 15) {
                map.removeLayer(layer_Contours20ftIntervals_1);
            }
        });
            if (map.getZoom() <= 19 && map.getZoom() >= 15) {
                map.addLayer(layer_Contours20ftIntervals_1);
            } else if (map.getZoom() > 19 || map.getZoom() < 15) {
                map.removeLayer(layer_Contours20ftIntervals_1);
            }
        var overlaysTree = [
            {label: '<img src="legend/SquatchHQ_10.png" /> Squatch HQ', layer: layer_SquatchHQ_10},
        {label: '<b>Squatchapple</b>', selectAllCheckbox: true, children: [
            {label: '<img src="legend/BlueMayappleLoop_9.png" /> Blue Mayapple Loop', layer: layer_BlueMayappleLoop_9},
            {label: '<img src="legend/GreenLocustGroveLoop_8.png" /> Green Locust Grove Loop', layer: layer_GreenLocustGroveLoop_8},
            {label: '<img src="legend/PinkTurtlebackLoop_7.png" /> Pink Turtleback Loop', layer: layer_PinkTurtlebackLoop_7},]},
        {label: '<b>Squatchy Surprise</b>', selectAllCheckbox: true, children: [
            {label: '<img src="legend/PinkLoop_6.png" /> Pink Loop', layer: layer_PinkLoop_6},
            {label: '<img src="legend/YellowBlackLoop_5.png" /> Yellow/Black Loop', layer: layer_YellowBlackLoop_5},
            {label: '<img src="legend/CheckeredLoop_4.png" /> Checkered Loop', layer: layer_CheckeredLoop_4},
            {label: '<img src="legend/BlueLoop_3.png" /> Blue Loop', layer: layer_BlueLoop_3},]},
        {label: '<b>5k Loop</b>', selectAllCheckbox: true, children: [
            {label: '<img src="legend/FrostyandSquatchyLeftoversLoop_2.png" /> Frosty and Squatchy Leftovers Loop', layer: layer_FrostyandSquatchyLeftoversLoop_2},]},
            {label: '<img src="legend/Contours20ftIntervals_1.png" /> Contours - 20ft Intervals', layer: layer_Contours20ftIntervals_1},
            {label: "OSM Standard", layer: layer_OSMStandard_0, radioGroup: 'bm' },]
        var lay = L.control.layers.tree(null, overlaysTree,{
            //namedToggle: true,
            //selectorBack: false,
            //closedSymbol: '&#8862; &#x1f5c0;',
            //openedSymbol: '&#8863; &#x1f5c1;',
            //collapseAll: 'Collapse all',
            //expandAll: 'Expand all',
            collapsed: true,
        });
        lay.addTo(map);
        setBounds();
        var i = 0;
        layer_SquatchHQ_10.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Name'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Name']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_SquatchHQ_10'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        resetLabels([layer_Contours20ftIntervals_1,layer_SquatchHQ_10]);
        map.on("zoomend", function(){
            resetLabels([layer_Contours20ftIntervals_1,layer_SquatchHQ_10]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_Contours20ftIntervals_1,layer_SquatchHQ_10]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_Contours20ftIntervals_1,layer_SquatchHQ_10]);
        });
        </script>

<script>
    // Store GPX tracks and elevation controls
/// Single elevation control
let currentElevationControl = null;
let currentElevationLayer = null;
let clickHandlersActive = true;

// Function to clear and remove elevation chart and related track
function clearElevationChart() {
    console.log("Clearing elevation chart");
    
    // Temporarily disable click handlers during cleanup
    clickHandlersActive = false;

    // Remove the elevation layer from the map
    if (currentElevationLayer && map.hasLayer(currentElevationLayer)) {
        console.log("Removing elevation path layer");
        map.removeLayer(currentElevationLayer);
        currentElevationLayer = null;
    }

    // Fully remove elevation control and its internals
    if (currentElevationControl) {
        try {
            console.log("Removing elevation control");
            
            // Try clearing hover marker and listeners
            if (currentElevationControl._marker) {
                map.removeLayer(currentElevationControl._marker);
                currentElevationControl._marker = null;
            }

            // Clean up event listeners
            if (currentElevationControl._mouseMoveHandler) {
                map.off("mousemove", currentElevationControl._mouseMoveHandler);
                currentElevationControl._mouseMoveHandler = null;
            }
            
            // Remove any additional custom listeners
            if (currentElevationControl._listeners) {
                for (const [event, handler] of Object.entries(currentElevationControl._listeners)) {
                    map.off(event, handler);
                }
                currentElevationControl._listeners = {};
            }

            // Properly remove the control from the map
            if (currentElevationControl.remove) {
                currentElevationControl.remove();
            } else if (currentElevationControl._container) {
                // Fallback removal if .remove() doesn't exist
                currentElevationControl._container.remove();
            }
            
            // Remove any custom close buttons we might have added
            const closeButtons = document.querySelectorAll('.elevation-close-btn');
            closeButtons.forEach(btn => btn.remove());
            
            currentElevationControl = null;
        } catch (e) {
            console.warn("Error removing elevation control:", e);
        }
    }

    // Clear any detached elevation div if used
    const elevationDiv = document.getElementById("elevation-div");
    if (elevationDiv) {
        elevationDiv.innerHTML = '';
        elevationDiv.style.display = 'none';
    }

    // Restore default cursor just in case
    map.getContainer().style.cursor = '';
    
    // Re-enable click handlers after a short delay
    setTimeout(function() {
        clickHandlersActive = true;
    }, 200);
}

// Function to load and display GPX elevation
function loadGPXElevation(gpxFilePath) {
    console.log("Loading GPX elevation for:", gpxFilePath);
    
    if (!clickHandlersActive) {
        console.log("Click handlers inactive, ignoring this click");
        return;
    }
    
    // Temporarily disable click handlers
    clickHandlersActive = false;
    
    // First clear any existing chart
    clearElevationChart();
    
    // Create new elevation control with a short delay to allow clearing to complete
    setTimeout(function() {
        try {
            console.log("Creating new elevation control");
            
            // Create fresh elevation control
            currentElevationControl = L.control.elevation({
                position: "bottomleft",
                theme: "lime-theme", // Match the example theme
                detached: false,     // Keep it attached to the map like in the example
                collapsed: false,    // Don't collapse it
                autohide: false,     // Don't hide automatically
                width: 400,          // Reasonable width for the chart
                height: 125,         // Height of the chart
                followMarker: true,
                hoverNumber: {
                    decimalsX: 2,
                    decimalsY: 0
                },
                imperial: true,
                useHeightIndicator: true,
                polylineOptions: {
                    color: "#566B13", // Match the lime theme color
                    opacity: 0.8
                }
            });
            
            // Initialize with empty _listeners property for cleanup
            currentElevationControl._listeners = {};
            
            // Add to map
            currentElevationControl.addTo(map);

            // Capture a reference to the layer that will be created
            const originalAddData = currentElevationControl.addData;
            currentElevationControl.addData = function(data) {
                const result = originalAddData.call(this, data);
                
                // After adding data, find the newly created layer
                map.eachLayer(function(layer) {
                    if (layer._path && !layer._isBaseLayer && !layer._checked) {
                        console.log("Found likely elevation path layer");
                        layer._checked = true;
                        currentElevationLayer = layer;
                    }
                });
                
                return result;
            };
            
            // Load the GPX file
            console.log("Loading GPX file:", gpxFilePath);
            currentElevationControl.load(gpxFilePath);
            
            // Add a close button to the elevation control
            setTimeout(function() {
                // Add close button to control
                if (currentElevationControl._container) {
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'elevation-close-btn';
                    closeBtn.innerHTML = '✖';
                    closeBtn.title = 'Close elevation profile';
                    closeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        clearElevationChart();
                    });
                    currentElevationControl._container.appendChild(closeBtn);
                }
                
                // Re-enable click handlers
                clickHandlersActive = true;
            }, 300);
            
        } catch (e) {
            console.error("Error creating elevation chart:", e);
            clickHandlersActive = true; // Re-enable click handlers even on error
        }
    }, 200);
}

// Add click handlers to all GeoJSON layers
function addGPXClickHandlers() {
    console.log("Adding GPX click handlers");
    
    map.eachLayer(function(layer) {
        if (layer.feature && layer.feature.properties && !layer._gpxClickHandlerAdded) {
            // Mark layer as having handler attached
            layer._gpxClickHandlerAdded = true;
            
            // Create click handler function
            const clickHandler = function(e) {
                // Immediately stop propagation
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                }
                
                // Only proceed if click handlers are active
                if (!clickHandlersActive) {
                    console.log("Click handlers inactive, ignoring click on feature");
                    return;
                }
                
                // Get feature and process GPX
                const feature = e.target.feature;
                if (feature.properties && feature.properties.gpx_file) {
                    const gpxFileName = feature.properties.gpx_file;
                    const gpxFilePath = `gpx_files/${gpxFileName}`;
                    console.log("Clicked feature with GPX:", gpxFilePath);
                    loadGPXElevation(gpxFilePath);
                } else {
                    console.log("Clicked feature has no GPX file associated");
                }
            };
            
            // Remove any existing click handlers first to prevent duplicates
            layer.off('click');
            
            // Add the click handler
            layer.on('click', clickHandler);
        }
    });
}

// Safe initialization function
function initElevationFeatures() {
    console.log("Initializing elevation features");
    
    // Create elevation-div if it doesn't exist
    if (!document.getElementById("elevation-div")) {
        const elevDiv = document.createElement("div");
        elevDiv.id = "elevation-div";
        elevDiv.style.position = "fixed";
        elevDiv.style.bottom = "10px";
        elevDiv.style.left = "10px";
        elevDiv.style.right = "10px";
        elevDiv.style.height = "200px";
        elevDiv.style.backgroundColor = "white";
        elevDiv.style.zIndex = "1000";
        elevDiv.style.display = "none";
        document.body.appendChild(elevDiv);
    }
    
    // Add handlers to existing GeoJSON layers
    addGPXClickHandlers();
    
    // Set up close button if it exists
    const closeBtn = document.getElementById("close-elevation");
    if (closeBtn) {
        closeBtn.addEventListener("click", function(e) {
            console.log("Close button clicked");
            e.stopPropagation(); // Prevent event bubbling
            clearElevationChart();
        });
    }
    
    // Add map click handler for clearing when clicking empty areas
    map.on('click', function(e) {
        console.log("Map background clicked");
        clearElevationChart();
    });
    
    // Add handler for new layers
    map.on('layeradd', function(e) {
        const layer = e.layer;
        if (layer.feature && layer.feature.properties && !layer._gpxClickHandlerAdded) {
            // Mark layer as having handler attached
            layer._gpxClickHandlerAdded = true;
            
            // Create click handler function
            const clickHandler = function(e) {
                // Immediately stop propagation
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                }
                
                // Only proceed if click handlers are active
                if (!clickHandlersActive) {
                    console.log("Click handlers inactive, ignoring click on feature");
                    return;
                }
                
                // Get feature and process GPX
                const feature = e.target.feature;
                if (feature.properties && feature.properties.gpx_file) {
                    const gpxFileName = feature.properties.gpx_file;
                    const gpxFilePath = `gpx_files/${gpxFileName}`;
                    console.log("Clicked feature with GPX:", gpxFilePath);
                    loadGPXElevation(gpxFilePath);
                } else {
                    console.log("Clicked feature has no GPX file associated");
                }
            };
            
            // Add the click handler
            layer.on('click', clickHandler);
        }
    });
}

// Additional CSS for elevation chart - add to your stylesheet or head
function addElevationStyles() {
    const styleEl = document.createElement('style');
    styleEl.innerHTML = `
    /* Style for when we need to use the detached mode */
    #elevation-div {
        position: fixed;
        bottom: 10px;
        left: 10px;
        width: 400px; 
        height: 200px;
        background-color: white;
        z-index: 1000;
        display: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        border-radius: 4px;
        overflow: hidden;
    }
    
    #elevation-div.visible {
        display: block;
    }
    
    /* Styling for the chart itself */
    .elevation-control.leaflet-control {
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        background: #fff;
        border-radius: 5px;
    }
    
    /* Lime theme styling to match example */
    .lime-theme.elevation-control.leaflet-control {
        border-radius: 0;
        background: none !important;
    }
    
    .lime-theme .area {
        fill: #9CC222;
        fill-opacity: 0.5;
    }
    
    .lime-theme .axis line {
        stroke: #566B13;
    }
    
    .lime-theme .axis path {
        stroke: #566B13;
    }
    
    .lime-theme .grid .tick line {
        stroke: #CDE926;
        stroke-opacity: 0.7;
    }
    
    .lime-theme .mouse-drag {
        fill: rgba(99, 126, 11, 0.4);
    }
    
    .lime-theme .mouse-focus-line {
        stroke: #566B13;
    }
    
    .lime-theme .mouse-focus-label {
        fill: #566B13;
    }
    
    .lime-theme .mouse-focus-label-rect {
        fill: white;
        fill-opacity: 0.95;
        stroke: #566B13;
        stroke-width: 1;
    }
    
    .lime-theme .grid path {
        stroke-width: 0;
    }
    
    .lime-theme .axis text {
        fill: #566B13;
    }
    
    /* Add a close button for attached mode */
    .elevation-close-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 9999;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 2px 4px;
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
    }
    `;
    
    document.head.appendChild(styleEl);
}

// Wait for document and map to load
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM content loaded, checking for map");
    
    // Add elevation styles
    addElevationStyles();
    
    // Check for map
    if (typeof map !== 'undefined') {
        console.log("Map is already defined");
        initElevationFeatures();
    } else {
        console.log("Waiting for map to be defined");
        // Set an interval to check for the map variable
        const mapCheckInterval = setInterval(function() {
            if (typeof map !== 'undefined') {
                console.log("Map is now defined");
                clearInterval(mapCheckInterval);
                initElevationFeatures();
            }
        }, 200);
        
        // Failsafe - try one more time after 3 seconds
        setTimeout(function() {
            if (typeof map === 'undefined') {
                console.warn("Map still not defined after timeout");
            } else if (!map._gpxHandlersInitialized) {
                console.log("Running init as failsafe");
                initElevationFeatures();
            }
        }, 3000);
    }
});
</script>
    </body>    
</html>
